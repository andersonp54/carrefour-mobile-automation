name: Mobile E2E (WDIO + Appium + Allure)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:

concurrency:
  group: mobile-e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  android:
    name: Android E2E
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      AVD_NAME: Medium_Phone_API_36.1
      ANDROID_API_LEVEL: 35
      ANDROID_TARGET: google_apis
      ANDROID_ARCH: x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Prepare folders
        run: |
          mkdir -p apps/android apps/ios reports/screenshots logs allure-results allure-report

      # --- Baixa APK do native-demo-app (release mais recente) ---
      - name: Download native-demo-app APK (latest release)
        shell: bash
        run: |
          set -e

          REPO="webdriverio/native-demo-app"
          API_URL="https://api.github.com/repos/${REPO}/releases/latest"

          echo "Fetching latest release from ${REPO}..."
          ASSET_URL=$(curl -s "${API_URL}" \
            | grep -Eo '"browser_download_url":\s*"[^"]+"' \
            | cut -d '"' -f4 \
            | grep -iE '\.apk$' \
            | head -n 1)

          if [ -z "$ASSET_URL" ]; then
            echo "❌ Não encontrei .apk no release latest do ${REPO}."
            echo "➡️ Ajuste o filtro grep -iE '\\.apk$' conforme o nome do asset."
            exit 1
          fi

          echo "Downloading APK: $ASSET_URL"
          curl -L "$ASSET_URL" -o apps/android/native-demo-app.apk
          ls -lah apps/android/

      # --- Appium ---
      - name: Install Appium + drivers
        run: |
          npm i -g appium@latest
          appium -v
          appium driver install uiautomator2
          appium driver list --installed

      - name: Start Appium
        run: |
          nohup appium --log-level info --log logs/appium-android.log --base-path /wd/hub --port 4723 >/dev/null 2>&1 &
          sleep 3
          echo "Appium started"

      # --- Emulator + testes ---
      - name: Run Android Emulator + WDIO tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          target: ${{ env.ANDROID_TARGET }}
          arch: ${{ env.ANDROID_ARCH }}
          profile: "pixel_6"
          avd-name: ${{ env.AVD_NAME }}
          emulator-options: >-
            -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
            -camera-back none -camera-front none
          disable-animations: true
          script: |
            adb devices -l
            adb shell getprop sys.boot_completed
            npm run test:android

      - name: Generate Allure report
        if: always()
        run: |
          npx allure generate allure-results --clean -o allure-report || true

      - name: Upload artifacts (Android)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            allure-results
            allure-report
            logs
            reports/screenshots
          if-no-files-found: warn


  ios:
    name: iOS E2E
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Prepare folders
        run: |
          mkdir -p apps/android apps/ios reports/screenshots logs allure-results allure-report

      # --- Baixa iOS app do native-demo-app (release mais recente) ---
      # Normalmente vem como .zip contendo .app (para Simulator). Ajuste o filtro se necessário.
      - name: Download native-demo-app iOS Simulator build (latest release)
        shell: bash
        run: |
          set -e

          REPO="webdriverio/native-demo-app"
          API_URL="https://api.github.com/repos/${REPO}/releases/latest"

          echo "Fetching latest release from ${REPO}..."
          ASSET_URL=$(curl -s "${API_URL}" \
            | grep -Eo '"browser_download_url":\s*"[^"]+"' \
            | cut -d '"' -f4 \
            | grep -iE '(ios|simulator|\.app\.zip|\.zip)$' \
            | head -n 1)

          if [ -z "$ASSET_URL" ]; then
            echo "❌ Não encontrei build iOS (zip/app) no release latest do ${REPO}."
            echo "➡️ Ajuste o filtro grep -iE '(ios|simulator|\\.app\\.zip|\\.zip)$' conforme o nome do asset."
            exit 1
          fi

          echo "Downloading iOS asset: $ASSET_URL"
          curl -L "$ASSET_URL" -o apps/ios/native-demo-ios.zip

          cd apps/ios
          unzip -o native-demo-ios.zip

          echo "Listing extracted files:"
          ls -lah

          # tenta localizar .app extraído
          IOS_APP=$(find . -maxdepth 3 -type d -name "*.app" | head -n 1 || true)
          if [ -z "$IOS_APP" ]; then
            echo "❌ Não encontrei .app após unzip. Talvez o asset seja .ipa ou estrutura diferente."
            echo "➡️ Ajuste a etapa para o formato do build iOS que você possui."
            exit 1
          fi

          echo "✅ Found iOS app: $IOS_APP"
          echo "$IOS_APP" > ../../ios_app_path.txt

      - name: Install Appium + drivers
        run: |
          npm i -g appium@latest
          appium -v
          appium driver install xcuitest
          appium driver list --installed

      - name: Start iOS Simulator
        shell: bash
        run: |
          xcrun simctl list devices available
          # você pode ajustar o device para o que sua config espera
          DEVICE_NAME="iPhone 15"
          UDID=$(xcrun simctl list devices available | grep -m 1 "$DEVICE_NAME" | awk -F '[()]' '{print $2}')
          if [ -z "$UDID" ]; then
            echo "❌ Não encontrei UDID para $DEVICE_NAME"
            exit 1
          fi
          echo "Using UDID: $UDID"
          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b

      - name: Start Appium
        run: |
          nohup appium --log-level info --log logs/appium-ios.log --base-path /wd/hub --port 4723 >/dev/null 2>&1 &
          sleep 3
          echo "Appium started"

      - name: Run iOS WDIO tests
        shell: bash
        run: |
          # se você quiser injetar o path do .app via env, use isso na sua wdio config
          IOS_APP_PATH=$(cat ios_app_path.txt)
          echo "IOS_APP_PATH=$IOS_APP_PATH"
          export IOS_APP_PATH="$IOS_APP_PATH"

          npm run test:ios

      - name: Generate Allure report
        if: always()
        run: |
          npx allure generate allure-results --clean -o allure-report || true

      - name: Upload artifacts (iOS)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: |
            allure-results
            allure-report
            logs
            reports/screenshots
          if-no-files-found: warn
