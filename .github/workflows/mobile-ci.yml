name: Mobile iOS Automation (WDIO + Appium + Allure)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:

jobs:
  ios-tests:
    runs-on: macos-latest
    timeout-minutes: 70

    env:
      DEVICE_NAME: "iPhone 16 Pro Max"
      IOS_VERSION: "iOS 18.6"
      APPIUM_PORT: "4723"
      CONFIGURATION: "Debug"
      # üëâ Se quiser for√ßar, pode definir aqui:
      # SCHEME: "Carrefour"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm i

      - name: List iOS runtimes and devices (debug)
        run: |
          xcrun simctl list runtimes
          xcrun simctl list devicetypes
          xcrun simctl list devices available

      - name: Download WebDriverIO Demo App v2.0.0
        run: |
          mkdir -p apps/ios
          # URL direta para o bin√°rio da release v2.0.0
          URL="https://github.com/webdriverio/native-demo-app/releases/download/v2.0.0/ios.simulator.wdio.native.app.v2.0.0.zip"
          
          echo "Baixando app de: $URL"
          curl -L "$URL" -o apps/ios/wdiodemoapp.zip
          
          # Verifica se o arquivo foi baixado e tem tamanho (n√£o √© um HTML de erro)
          if [ $(stat -f%z apps/ios/wdiodemoapp.zip) -lt 100000 ]; then
            echo "‚ùå Erro: O arquivo baixado √© muito pequeno. Verifique a URL."
            exit 1
          fi

          echo "Extraindo app..."
          unzip apps/ios/wdiodemoapp.zip -d apps/ios/
          
          # Define o caminho para o ambiente do GitHub
          ACTUAL_APP_PATH=$(find apps/ios -name "*.app" | head -n 1)
          
          if [ -z "$ACTUAL_APP_PATH" ]; then
            echo "‚ùå Erro: Arquivo .app n√£o encontrado ap√≥s extra√ß√£o."
            exit 1
          fi

          echo "IOS_APP_PATH=$PWD/$ACTUAL_APP_PATH" >> $GITHUB_ENV
          echo "‚úÖ App v2.0.0 pronto em: $ACTUAL_APP_PATH"

      - name: Create iOS Simulator (fixed model + iOS)
        shell: bash
        run: |
          set -euo pipefail

          RUNTIME_ID=$(xcrun simctl list runtimes | grep "^${IOS_VERSION} " | awk -F' - ' '{print $NF}' | head -n 1)
          DEVICE_TYPE_ID=$(xcrun simctl list devicetypes | grep "^${DEVICE_NAME} " | awk -F'[()]' '{print $2}' | head -n 1)

          if [ -z "$RUNTIME_ID" ] || [ -z "$DEVICE_TYPE_ID" ]; then
            echo "‚ùå Runtime or DeviceType not found"
            exit 1
          fi

          UDID=$(xcrun simctl create "${DEVICE_NAME} CI" "$DEVICE_TYPE_ID" "$RUNTIME_ID")
          echo "SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"

      - name: Boot iOS Simulator
        shell: bash
        run: |
          xcrun simctl shutdown "$SIMULATOR_UDID" || true
          xcrun simctl erase "$SIMULATOR_UDID" || true
          xcrun simctl boot "$SIMULATOR_UDID" || true
          xcrun simctl bootstatus "$SIMULATOR_UDID" -b

      - name: Free Appium port
        shell: bash
        run: |
          lsof -ti tcp:${APPIUM_PORT} | xargs -r kill -9 || true

      - name: Run WDIO tests (iOS)
        shell: bash
        run: |
          npx wdio run wdio.conf.js --maxInstances 1
        env:
          IOS_APP_PATH: ${{ env.IOS_APP_PATH }}
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          # For√ßa o Node a ignorar timeouts de cabe√ßalho curtos
          NODE_OPTIONS: "--max-http-header-size=16384" 

      - name: Upload Appium Logs (Se falhar)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-server-log
          path: appium.log

      - name: Generate Allure report (HTML)
        if: always()
        run: npx allure generate allure-results --clean -o allure-report

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results
